name: Build and Submit Android

on:
  workflow_dispatch:

jobs:
  build:
    name: Build and Submit Android
    runs-on: ubuntu-latest

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
      ANDROID_SERVICE_ACCOUNT_JSON: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3Ô∏è‚É£ Cache Yarn dependencies
      - name: Cache Yarn dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/yarn
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: yarn install

      # 5Ô∏è‚É£ Install EAS CLI
      - name: Install EAS CLI
        run: yarn global add eas-cli

      # 6Ô∏è‚É£ Configure Google Play credentials
      - name: Configure Google Play credentials
        run: |
          mkdir -p ./credentials
          printf "%s" "${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}" > ./credentials/service-account.json
          echo "Service account JSON copied successfully."

      # 7Ô∏è‚É£ Validate service account JSON
      - name: Validate Google Service Account JSON
        run: |
          echo "Validating Google Service Account JSON..."
          jq '.' ./credentials/service-account.json
          jq -e '.type, .project_id, .private_key_id, .private_key, .client_email' ./credentials/service-account.json
          echo "Google Service Account JSON is valid."

      # 8Ô∏è‚É£ Determine EAS profile
      - name: Determine EAS profile
        id: profile
        run: echo "profile=staging" >> $GITHUB_OUTPUT

      # 9Ô∏è‚É£ Restore cached/build artifact
      # Restore previous build artifact
      - name: Restore previous build artifact
        uses: actions/download-artifact@v3.1.2
        with:
          name: app-release
          path: ./builds
        continue-on-error: true

      - name: Cache builds folder
        uses: actions/cache@v3
        with:
          path: ./builds
          key: builds-${{ hashFiles('app.json') }}
          restore-keys: builds-

      # üîü Build Android (Local) only if .aab not exists
      - name: Build Android (Local)
        run: |
          mkdir -p ./builds
          if [ ! -f ./builds/app-release.aab ]; then
            echo "No previous build found. Building..."
            export NODE_OPTIONS="--max-old-space-size=4096"
            eas build --platform android \
              --profile ${{ steps.profile.outputs.profile }} \
              --local --output ./builds/app-release.aab \
              --non-interactive
          else
            echo "Build already exists. Skipping local build."
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload AAB artifact
      - name: Upload AAB artifact
        if: always()
        uses: actions/upload-artifact@v3.1.2
        with:
          name: app-release
          path: ./builds/app-release.aab

      # 1Ô∏è‚É£2Ô∏è‚É£ Submit to Google Play
      - name: Submit to Google Play
        run: |
          eas submit --platform android \
            --path ./builds/app-release.aab \
            --profile staging \
            --non-interactive
