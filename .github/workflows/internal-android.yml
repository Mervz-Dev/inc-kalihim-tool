name: Build and Submit Android

on:
  workflow_dispatch:

jobs:
  build:
    name: Build and Submit Android
    runs-on: ubuntu-latest

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
      ANDROID_SERVICE_ACCOUNT_JSON: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3Ô∏è‚É£ Cache Yarn dependencies
      - name: Cache Yarn dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/yarn
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: yarn install

      # 5Ô∏è‚É£ Install EAS CLI
      - name: Install EAS CLI
        run: yarn global add eas-cli

      # 6Ô∏è‚É£ Configure Google Play credentials
      - name: Configure Google Play credentials
        run: |
          mkdir -p ./credentials
          printf "%s" "${ANDROID_SERVICE_ACCOUNT_JSON}" > ./credentials/service-account.json
          echo "Service account JSON copied successfully."

      # 7Ô∏è‚É£ Validate service account JSON
      - name: Validate Google Service Account JSON
        run: |
          jq '.' ./credentials/service-account.json
          jq -e '.type, .project_id, .private_key_id, .private_key, .client_email' ./credentials/service-account.json
          echo "Service account JSON structure is valid."

      # 8Ô∏è‚É£ Determine EAS profile
      - name: Determine EAS profile
        id: profile
        run: echo "profile=staging" >> $GITHUB_OUTPUT

      # 9Ô∏è‚É£ Read version from app.json
      - name: Read app version
        id: version
        run: |
          version=$(jq -r '.expo.version' app.json)
          echo "Detected version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      # üîü Try to restore existing artifact
      - name: Restore previous build artifact
        id: restore-artifact
        uses: actions/download-artifact@v4
        with:
          name: ikt-release-${{ steps.version.outputs.version }}
          path: ./builds
        continue-on-error: true

      # 1Ô∏è‚É£1Ô∏è‚É£ Check if artifact exists
      - name: Check if AAB exists
        id: check-artifact
        run: |
          version=${{ steps.version.outputs.version }}
          file="./builds/ikt-release-${version}.aab"
          if [ -f "$file" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Build Android only if artifact does not exist
      - name: Build Android (Local)
        if: steps.check-artifact.outputs.exists == 'false'
        run: |
          mkdir -p ./builds
          export NODE_OPTIONS="--max-old-space-size=4096"
          version=${{ steps.version.outputs.version }}
          output_file="./builds/ikt-release-${version}.aab"
          echo "Building and saving to $output_file"
          eas build --platform android \
            --profile ${{ steps.profile.outputs.profile }} \
            --local --output "$output_file" \
            --non-interactive

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload AAB artifact
      - name: Upload AAB artifact
        if: steps.check-artifact.outputs.exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ikt-release-${{ steps.version.outputs.version }}
          path: ./builds/ikt-release-${{ steps.version.outputs.version }}.aab

      # 1Ô∏è‚É£4Ô∏è‚É£ Submit to Google Play
      - name: Submit to Google Play
        run: |
          version=${{ steps.version.outputs.version }}
          file="./builds/ikt-release-${version}.aab"
          echo "Submitting $file to Google Play..."
          eas submit --platform android \
            --path "$file" \
            --profile ${{ steps.profile.outputs.profile }} \
            --non-interactive
